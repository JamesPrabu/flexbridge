<?xml version="1.0" encoding="UTF-8"?>
<!-- These variables define the Windows Installer product version, product code and upgrade code. They   -->
<!-- will be used later on in this file.  this value should be B U I  LD_SCRIPT_MUST_REPLACE_AT_RUNTIME  (in quotes)-->
<?define Property_ProductVersion = ".*" ?>
<!--this is replaced at build time by the msbuild 'package' target -->
<!--Don't even think of EVER changing this -->
<?define Property_ProductCode = "FDD4B174-8190-4819-880F-77D1F9F1DA9C" ?>
<!-- NO! auto-generate a new guid each time -->
<!--Don't even think of EVER changing the Property_UpgradeCode. -->
<?define Property_UpgradeCode = "C1EDBBD1-E382-11DE-8A39-0800200C9A66" ?>

<!-- good intro to the component vs. file thing, and why each file here is a separate component:
http://blogs.msdn.com/robmen/archive/2003/10/04/56479.aspx -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <Product Id="$(var.Property_ProductCode)" Name="FLEx Bridge" Language="1033" Version="$(var.Property_ProductVersion)" Manufacturer="SIL" UpgradeCode="$(var.Property_UpgradeCode)">

	<!-- autogenerated package id -->
	<Package Id="*" Compressed="yes" InstallerVersion="200"/>

	<Upgrade Id="$(var.Property_UpgradeCode)">
	  <UpgradeVersion Minimum="$(var.Property_ProductVersion)" OnlyDetect="yes" Property="NEWVERSIONDETECTED"/>
	  <UpgradeVersion Minimum="0.0.0" IncludeMinimum="yes" Maximum="$(var.Property_ProductVersion)" IncludeMaximum="no" Property="OLDERVERSIONBEINGUPGRADED"/>
	</Upgrade>

	<UIRef Id="WixUI_Minimal"/>
	<WixVariable Id="WixUILicenseRtf" Value="..\..\distfiles\License.rtf"/>

	<Property Id="FW7INSTALLDIR">
	  <RegistrySearch Id="SearchForFW7" Root="HKLM" Key="SOFTWARE\[Manufacturer]\FieldWorks\7.0" Name="RootCodeDir" Type="raw"/>
	</Property>

	<Property Id="FIELDWORKSMINIMUMINSTALLEDVERSION">
	  <DirectorySearch Id="FWVersion" Path="[FW7INSTALLDIR]">
		<!-- 7.2.0.40926 was the actual released number,
				but I understand one then needs to go one notch under that to find 7.2.0.40926 -->
		<FileSearch Name="FieldWorks.exe" MinVersion="7.2.0.40925"/>
	  </DirectorySearch>
	</Property>

	<!--
	"from the list: Don't use Advertise="yes" Advertised shortcuts are designed to allow
users to install just the shortcut for your app, then demand-install the
rest of the app the first time the icon is run.  If this is not behavior you
are trying to support, you're better off using non-advertised shortcuts. "-->

	<Condition Message="Before [ProductName] $(var.Property_ProductVersion) can install, you need to install SIL's FieldWorks 7.2, or higher.">
	  <![CDATA[Installed OR FIELDWORKSMINIMUMINSTALLEDVERSION]]>
	</Condition>

	<PropertyRef Id="NETFRAMEWORK35"/>
	<Condition Message="Before [ProductName] $(var.Property_ProductVersion) can install, you need to install Microsoft's free .NET Framework 3.5.">
	  <![CDATA[Installed OR NETFRAMEWORK35]]>
	</Condition>

	<!--because of bug, this needs to be 1 -->
	<Property Id="ALLUSERS">1</Property>

	<Media Id="1" Cabinet="product.cab" EmbedCab="yes"/>

	<Directory Id="TARGETDIR" Name="SourceDir">

	  <Directory Id="ProgramFilesFolder" Name="PFiles">
		<Directory Id="SILDIR" Name="SIL">
		  <Directory Id="INSTALLDIR" Name="FLEx Bridge">
			<Component Id="FLExBridge.exe" Guid="3D9BF2DF-4A25-11DF-9879-0800200C9A66">
			  <File Id="FLExBridge.exe" Name="FLExBridge.exe" Source="..\..\output\Release\FLExBridge.exe"/>
			  <Shortcut Id="desktopFLExBridgeShortcut" Directory="DesktopFolder" Name="FLEx Bridge" WorkingDirectory="INSTALLDIR" Target="[!FLExBridge.exe]" Icon="FLExBridge.ico"/>
			  <RemoveFolder Id="DesktopFolder" On="uninstall"/>
			  <RegistryValue Root="HKCU" Key="Software\[Manufacturer]\FLEX Bridge" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
			</Component>
			<Component Id="RegInstallationDir" Guid="C1EDBBD7-E382-11DE-8A39-0800200C9A66">
			  <RegistryKey Id="keyFLExBridge.exe" Action="createAndRemoveOnUninstall" Root="HKLM" Key="SOFTWARE\[Manufacturer]\FLEX Bridge\7">
				<RegistryValue Id="FLExBridgeInstallationDir" Type="string" Value="[INSTALLDIR]" Name="InstallationDir"/>
			  </RegistryKey>
			</Component>
			<Component Id="FLExBridge.pdb" Guid="C1EDBBD2-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExBridge.pdb" Name="FLEx-FLExBridge.pdb" KeyPath="yes" Source="..\..\output\Release\FLExBridge.pdb"/>
			</Component>
			<Component Id="FLExChorusPlugin.dll" Guid="C1ED6DB1-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExChorusPlugin.dll" Name="FLEx-ChorusPlugin.dll" KeyPath="yes" Source="..\..\output\Release\FLEx-ChorusPlugin.dll"/>
			</Component>
			<Component Id="FLExChorusPlugin.pdb" Guid="C1EDBBD3-E382-11DE-8A39-0800200C9A66">
			  <File Id="FLExChorusPlugin.pdb" Name="FLEx-ChorusPlugin.pdb" KeyPath="yes" Source="..\..\output\Release\FLEx-ChorusPlugin.pdb"/>
			</Component>
			<Component Id="Autofac.dll" Guid="3D9BF2E0-4A25-11DF-9879-0800200C9A66">
			  <File Id="Autofac.dll" Name="Autofac.dll" KeyPath="yes" Source="..\..\output\Release\Autofac.dll"/>
			</Component>
			<Component Id="Chorus.exe" Guid="3D9BF2E3-4A25-11DF-9879-0800200C9A66">
			  <File Id="Chorus.exe" Name="Chorus.exe" KeyPath="yes" Source="..\..\output\Release\Chorus.exe"/>
			</Component>
			<Component Id="Chorus.pdb" Guid="C1EDBBD4-E382-11DE-8A39-0800200C9A66">
			  <File Id="Chorus.pdb" Name="Chorus.pdb" KeyPath="yes" Source="..\..\output\Release\Chorus.pdb"/>
			</Component>
			<Component Id="ChorusMerge.exe" Guid="3D9BF2E1-4A25-11DF-9879-0800200C9A66">
			  <File Id="ChorusMerge.exe" Name="ChorusMerge.exe" KeyPath="yes" Source="..\..\output\Release\ChorusMerge.exe"/>
			</Component>
			<Component Id="ChorusMerge.pdb" Guid="C1EDBBD5-E382-11DE-8A39-0800200C9A66">
			  <File Id="ChorusMerge.pdb" Name="ChorusMerge.pdb" KeyPath="yes" Source="..\..\output\Release\ChorusMerge.pdb"/>
			</Component>
			<Component Id="LibChorus.dll" Guid="3D9BF2E2-4A25-11DF-9879-0800200C9A66">
			  <File Id="LibChorus.dll" Name="LibChorus.dll" KeyPath="yes" Source="..\..\output\Release\LibChorus.dll"/>
			</Component>
			<Component Id="LibChorus.pdb" Guid="C1EDBBD6-E382-11DE-8A39-0800200C9A66">
			  <File Id="LibChorus.pdb" Name="LibChorus.pdb" KeyPath="yes" Source="..\..\output\Release\LibChorus.pdb"/>
			</Component>
			<Component Id="Palaso.dll" Guid="3D9BF2E4-4A25-11DF-9879-0800200C9A66">
			  <File Id="Palaso.dll" Name="Palaso.dll" KeyPath="yes" Source="..\..\output\Release\Palaso.dll"/>
			</Component>
			<Component Id="icu.net.dll" Guid="3D9BF2E5-4A25-11DF-9879-0800200C9A66">
			  <File Id="icu.net.dll" Name="icu.net.dll" KeyPath="yes" Source="..\..\output\Release\icu.net.dll"/>
			</Component>
			<!-- Hopefully, the generated stuff will see that all the Hg gets added here. -->
			<Directory Id="MercurialDir" Name="Mercurial"/>
			<Directory Id="MercurialExtensionsDir" Name="MercurialExtensions"/>
		  </Directory>
		</Directory>
	  </Directory>

	  <Directory Id="ProgramMenuFolder" Name="Programs">
		<Directory Id="DesktopFolder" SourceName="Desktop"/>
		<Directory Id="FLExBridgeShortcutDir" Name="FLEx Bridge">
		  <Component Id="ApplicationShortcut" Guid="3D9BF2DE-4A25-11DF-9879-0800200C9A66">
			<Shortcut Id="startmenuShortcut" Name="FLEx Bridge" Target="[!FLExBridge.exe]" WorkingDirectory="INSTALLDIR" Icon="FLExBridge.ico"/>
			<RemoveFolder Id="FLExBridgeShortcutDir" On="uninstall"/>
			<RegistryValue Root="HKCU" Key="Software\[Manufacturer]\[ProductName]" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
		  </Component>
		</Directory>
	  </Directory>
	</Directory>

	<Feature Id="ProductFeature" Level="1" Title="Basic Stuff">
	  <ComponentRef Id="FLExBridge.exe"/>
	  <ComponentRef Id="FLExBridge.pdb"/>
	  <ComponentRef Id="FLExChorusPlugin.dll"/>
	  <ComponentRef Id="FLExChorusPlugin.pdb"/>
	  <ComponentRef Id="ApplicationShortcut"/>
	  <ComponentRef Id="RegInstallationDir"/>
	  <ComponentRef Id="Autofac.dll"/>
	  <ComponentRef Id="LibChorus.dll"/>
	  <ComponentRef Id="LibChorus.pdb"/>
	  <ComponentRef Id="Chorus.exe"/>
	  <ComponentRef Id="Chorus.pdb"/>
	  <ComponentRef Id="ChorusMerge.exe"/>
	  <ComponentRef Id="ChorusMerge.pdb"/>
	  <ComponentRef Id="Palaso.dll"/>
	  <ComponentRef Id="icu.net.dll"/>
	  <!-- Generated components (originally, but now stored in Mercurial). Regenerate, if the contents change, or hand-edit, for say DistFiles. -->
	  <ComponentGroupRef Id="DistFiles"/>
	  <ComponentGroupRef Id="MercurialFiles"/>
	  <ComponentGroupRef Id="MercurialExtensionsFiles"/>
	</Feature>

	<Icon Id="FLExBridge.ico" SourceFile="..\..\output\Release\FLExBridge.exe"/>
	<!-- what you see in add/remove programs control panel -->
	<Property Id="ARPPRODUCTICON" Value="FLExBridge.ico"/>

	<InstallExecuteSequence>
	  <RemoveExistingProducts After="InstallInitialize"/>
	</InstallExecuteSequence>
  </Product>
</Wix>
